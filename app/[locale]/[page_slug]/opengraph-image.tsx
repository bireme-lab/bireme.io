import { Locale } from "@/utils/i18n";
import * as MDX from "@/utils/mdx";
import { Option } from "@swan-io/boxed";
import { GeistSans } from "geist/font/sans";
import { ImageResponse } from "next/og";
import { match, P } from "ts-pattern";

// Route segment config
export const runtime = "nodejs";

const getPost = async (slug: string, locale: Locale) => {
  return match(await MDX.Post.findBySlug(slug, locale))
    .with(Option.P.Some(P.select()), (post) => post)
    .otherwise(() => {
      throw new Error(`Post not found for slug: ${slug}`);
    });
};

type Props = {
  params: {
    page_slug: string;
    locale: Locale;
  };
};

export async function generateImageMetadata({ params }: Props) {
  const post = await getPost(params.page_slug, params.locale);

  return [
    {
      id: post.slug,
      size: { width: 1200, height: 630 },
      alt: post.title,
      contentType: "image/png",
    },
  ];
}

const Image = async ({ params }: Props) => {
  const post = await getPost(params.page_slug, params.locale);

  return new ImageResponse(
    (
      <div
        style={{
          ...GeistSans.style,
          fontSize: 32,
          fontWeight: 600,
          background: "#151515",
          color: "#F9EADE",
          position: "relative",
          width: "100%",
          height: "100%",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
        }}
      >
        <div
          style={{
            pointerEvents: "none",
            userSelect: "none",
            position: "absolute",
            top: 0,
            right: 0,
            left: 0,
            transform: "translate(50%, -75%)",
            margin: "0 auto",
            width: "1500px",
            height: "1000px",
            background: "#E4CC4C",
            opacity: 0.2,
            borderRadius: "50%",
            filter: "blur(150px)",
          }}
        />
        <div>{post.title}</div>
        <svg
          style={{
            position: "absolute",
            bottom: 100,
          }}
          xmlns="http://www.w3.org/2000/svg"
          width="137,5"
          height="20"
          fill="none"
        >
          <path
            fill="currentColor"
            d="M8.038 1.68c2.044.02 4.657 1.103 5.286 3.264.206.773.072 1.473-.402 2.1-1.005 1.233-2.738 1.633-4.198 2.02a.019.019 0 0 1-.023-.018c.058-2.038.126-4.076.202-6.113.01-.27.03-.538.06-.806a.022.022 0 0 0-.018-.024l-.012.001c-.529.214-1.017 1.006-1.245 1.501-.747 1.626-1.272 3.362-1.743 5.084-.35 1.277-.706 2.55-1.07 3.823-.775 2.706-1.814 5.073-4.04 6.816-.244.19-.49.38-.736.566-.144.109-.13.134.04.075a15.442 15.442 0 0 0 2.845-1.33c.365-.216.736-.421 1.112-.615.274-.14.503-.095.689.138.164.205.324.413.48.624a.142.142 0 0 0 .182.042c.387-.202.784-.775 1.019-1.138 1.492-2.308 2.082-5.03 2.195-7.744 0-.025.013-.034.037-.026 1.365.437 2.675 1.092 3.535 2.255.684.978.813 2.179.27 3.24-.37.721-1.004 1.319-1.665 1.78-.89.592-1.841 1.087-2.836 1.478-.693.272-1.524.503-2.257.482-.098-.002-.105.022-.021.072 1.468.893 3.363.85 5.065.663a20.52 20.52 0 0 0 3.985-.833c2.289-.72 5.42-2.48 5.217-5.334-.106-1.478-1.292-2.568-2.58-3.103-1.015-.422-2.305-.74-3.435-.994-.068-.016-.071-.04-.009-.07 1.692-.847 3.376-2.308 4.166-4.038.666-1.457.578-3.035-.799-4.053-.945-.7-2.21-1.096-3.39-1.298-2.847-.458-5.653.047-8.253 1.26-2.409 1.125-4.154 3.08-4.066 5.886.022.722.178 1.416.466 2.081a.098.098 0 0 0 .061.055l.023.008h.01a.017.017 0 0 0 .012-.013v-.01c-.56-1.633-.558-3.37.37-4.867 1.106-1.789 3.393-2.91 5.47-2.888ZM32 15.454V4.545h3.814c.76 0 1.387.132 1.88.395.494.259.861.609 1.103 1.049.241.437.362.922.362 1.454 0 .469-.083.856-.25 1.161-.164.306-.38.547-.65.725a2.958 2.958 0 0 1-.868.394v.107c.333.02.669.138 1.006.351.338.213.62.519.847.916.228.398.341.885.341 1.46a2.93 2.93 0 0 1-.373 1.475c-.248.437-.64.783-1.177 1.039-.536.256-1.234.383-2.093.383H32Zm1.321-1.171h2.62c.864 0 1.476-.167 1.838-.501.366-.337.55-.746.55-1.225 0-.37-.095-.71-.283-1.023a2.042 2.042 0 0 0-.804-.756c-.348-.192-.76-.288-1.236-.288H33.32v3.793Zm0-4.944h2.45c.398 0 .757-.078 1.076-.234a1.88 1.88 0 0 0 .767-.66c.192-.284.288-.618.288-1.002 0-.48-.167-.886-.5-1.22-.334-.337-.864-.506-1.588-.506H33.32V9.34ZM45.327 4.545v10.91h-1.321V4.544h1.32ZM50.226 15.454V4.545h3.686c.852 0 1.552.146 2.098.437.547.288.952.684 1.215 1.188.263.504.394 1.078.394 1.72 0 .643-.131 1.213-.394 1.71-.263.498-.666.888-1.21 1.172-.543.28-1.237.421-2.082.421H50.95V10h2.94c.583 0 1.051-.085 1.407-.256.358-.17.617-.412.777-.724.164-.316.245-.693.245-1.13 0-.436-.081-.818-.245-1.145a1.67 1.67 0 0 0-.783-.756c-.358-.181-.832-.272-1.422-.272h-2.322v9.737h-1.321Zm5.135-4.9 2.684 4.9h-1.534l-2.642-4.9h1.492ZM62.07 15.454V4.545h6.584v1.172h-5.263v3.686h4.922v1.172h-4.922v3.708h5.348v1.171H62.07ZM73.285 4.545h1.577l3.707 9.056h.128l3.707-9.056h1.577v10.91h-1.236V7.165h-.106l-3.41 8.288h-1.192l-3.41-8.288h-.106v8.288h-1.236V4.545ZM88.88 15.454V4.545h6.584v1.172H90.2v3.686h4.922v1.172H90.2v3.708h5.348v1.171h-6.67ZM106.563 15.454V4.545h1.321v9.738h5.072v1.171h-6.393ZM118.387 15.454h-1.385l4.006-10.909h1.363l4.006 10.91h-1.385l-3.26-9.184h-.085l-3.26 9.183Zm.511-4.26h5.583v1.171h-5.583v-1.172ZM130.326 15.454V4.545h3.814c.76 0 1.387.132 1.88.395.494.259.862.609 1.103 1.049.242.437.362.922.362 1.454 0 .469-.083.856-.25 1.161-.163.306-.38.547-.65.725a2.958 2.958 0 0 1-.868.394v.107c.334.02.669.138 1.007.351.337.213.619.519.846.916.228.398.341.885.341 1.46 0 .547-.124 1.038-.372 1.475-.249.437-.641.783-1.178 1.039-.536.256-1.234.383-2.093.383h-3.942Zm1.321-1.171h2.621c.863 0 1.475-.167 1.838-.501.365-.337.548-.746.548-1.225 0-.37-.094-.71-.282-1.023a2.04 2.04 0 0 0-.804-.756c-.348-.192-.76-.288-1.236-.288h-2.685v3.793Zm0-4.944h2.45c.398 0 .757-.078 1.076-.234.324-.156.579-.376.768-.66.191-.284.287-.618.287-1.002 0-.48-.167-.886-.501-1.22-.333-.337-.862-.506-1.587-.506h-2.493V9.34Z"
          />
        </svg>
      </div>
    ),
  );
};

export default Image;
